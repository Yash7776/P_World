{% load static %}
{% include 'customer/header.html' %}

<style>
  /* Ensure main content takes full viewport height minus header/footer */
  .page-wrapper {
    min-height: calc(100vh - 200px); /* Adjust 200px based on your header+footer height */
    display: flex;
    flex-direction: column;
  }
  
  .main-content-wrapper {
    flex: 1;
    padding-bottom: 40px;
  }
</style>

<!-- Wrap everything in a page wrapper -->
<div class="page-wrapper">
  <div class="main-content-wrapper">
    <section>
      <div class="container" style='margin-top: -4%;'>
        <div class="row">  
          <div class="col-md-12 ">
            <h2 class="title text-center">Shop Checkout</h2>
            <button class="login-btn nextBtn btn-danger btn-sm" onclick="window.location.href='/items/'" style="float: right;margin-top: -4%;" data-toggle="tooltip" data-placement="top" title="Back" ><i class="fa fa-arrow-left" aria-hidden="true" style="cursor:pointer;"></i></button>
          </div>
        </div>
        
        {% if Item_count != 0 %}
        <div class="section-content" style="margin-top: -2%;" id="item_div">
          <div class="row mt-30">
            <div class="col-md-8">
              <h3 class="mb-30">Your Items</h3>
              <div class='mr-50'>
                <div id="cart_item" class="overflow-auto" style="max-height: 400px;overflow-y: auto;overflow-x: hidden;">
                  {{string}}
                </div>
                <hr>
                <div class="card shodow">
                  <h3 class="checout-title" style="margin-top:-1%; font-size: 1.6rem; text-align: center;">Order Summary</h3>
                  <div style="display: flex;justify-content: space-between;"> 
                    <h4 style="margin-bottom:0!important;">Item SubTotal</h4> 
                    <h4 style="margin-bottom:0!important; color: gray;">$<span id="sub_total">{{sub_total}}</span></h4>  
                  </div>
                  <div style="display: flex;justify-content: space-between;"> 
                    <h4 style="margin-bottom:0!important;"> Delivery Charges </h4> 
                    <h4 style="margin-bottom:0!important; color: gray;">$<span id="delivery_charge">{{delivery_charges}}</span></h4> 
                  </div>
                  <div style="display: flex;justify-content: space-between;"> 
                    <h4 style="margin-bottom:0!important;"> Convinience Fee </h4> 
                    <h4 style="margin-bottom:0!important; color: gray;">$<span id="convinience_fee">{{convinience_fee}}</span></h4> 
                  </div>
                  <div style="display: flex;justify-content: space-between;"> 
                    <h4 style="margin-bottom:0!important;"> Total Amount </h4> 
                    <h4 style="margin-bottom:0!important; color: gray;">$<span id="total_amount">{{total_amount}}</span></h4> 
                  </div>
                  <a class="btn btn-danger mt-10" id="place" onclick='placeOrder()'>Place Order</a> 
                </div>
              </div>
            </div>
            
            <div class="col-md-4" id="address_div">
              <div class="billing-details">
                <h3 class="mb-30">Delivery Address</h3>
                <div class="row">
                  <div class="form-group col-md-12">
                    <label for="name">Full Name <span style='color:red;'>*</span></label>
                    <input id="name" type="text" class="form-control" placeholder="Full Name" value="{{address_obj.name}}">
                    <span id="errmsg1" style="color:red; display:none;"></span>
                  </div>
                  
                  <div class="col-md-12"> 
                    <div class="form-group">
                      <label for="email">Email Address <span style='color:red;'>*</span></label>
                      <input id="email" type="email" class="form-control" placeholder="Email Address" value="{{address_obj.email}}">
                      <span id="errmsg2" style="color:red; display:none;"></span>
                    </div>
                    <div class="form-group">
                      <label for="address1">Address 1 <span style='color:red;'>*</span></label>
                      <input type="text" class="form-control" id="address1" name="address" placeholder="Address 1" value="{{address_obj.address1}}"> 
                      <span id="errmsg3" style="color:red; display:none;"></span>
                    </div>
                    <div class="form-group">
                      <label for="address2">Address 2</label>
                      <input type="text" id='address2' class="form-control" placeholder="Address 2" value="{{address_obj.address2}}">
                    </div>
                  </div>
                  
                  <div class="form-group col-md-6">
                    <label>Country <span style='color:red;'>*</span></label>
                    <select class="form-control" id='country' onchange='getProvince()'>
                      <option selected style='background:rgb(50 48 48);color:#bbb6b6;' value=''>{{address_obj.country}}</option> 
                      {% for obj in country_obj %}
                        <option {% if obj.name == address_obj.country %} selected value="{{obj.id}}" {% else %} value="{{obj.id}}" {% endif %} style='background:rgb(50 48 48);color:#bbb6b6;'> {{obj.name}}</option>  
                      {% endfor %}
                    </select>
                    <span id="errmsg9" style="color:red; display:none;"></span>
                  </div>
                  
                  <div class="form-group col-md-6">
                    <label>Province <span style='color:red;'>*</span></label>
                    <select class="form-control" id='province' onchange='getState()'>
                      <option selected style='background:rgb(50 48 48);color:#bbb6b6;' value=''>Select Province</option> 
                    </select>
                    <span id="errmsg6" style="color:red; display:none;"></span>
                  </div>
                  
                  <div class="form-group col-md-6">
                    <label for="city">City <span style='color:red;'>*</span></label>
                    <select class="form-control" id='city'>
                      <option selected style='background:rgb(50 48 48);color:#bbb6b6;' value=''>select City</option> 
                    </select>
                    <span id="errmsg7" style="color:red; display:none;"></span>
                  </div>
                  
                  <div class="form-group col-md-6">
                    <label for="postal_code">Postal Code <span style='color:red;'>*</span></label>
                    <input id="postal_code" type="text" class="form-control" placeholder="Postal Code" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\..*)\./g, '$1');" maxlength='5' value="{{address_obj.postalcode}}">
                    <span id="errmsg8" style="color:red; display:none;"></span>
                  </div>
                  
                  <div class="col-md-12"> 
                    <label for="mobile">Mobile No.<span style='color:red;'>*</span></label>   
                  </div>
                  <div class='form-group col-md-4'>
                    <input id="dial_code" type="text" class="form-control" placeholder="Dial Code" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\..*)\./g, '$1');" maxlength='5' value="{{address_obj.country_code}}">
                    <span id="errmsg4" style="color:red;font-size: 13px; display:none;"></span>
                  </div>
                  <div class='form-group col-md-8'>
                    <input type="text" class="form-control" id="mobile" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\..*)\./g, '$1');" name="mobile" placeholder="Mobile" maxlength='10' value="{{address_obj.mobile_no}}">
                    <span id="errmsg5" style="color:red; display:none;"></span> 
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Order Notes</label>
                  <textarea class="form-control" id='note' placeholder="Notes about your order, e.g. special notes for delivery." rows="3"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="row" style="margin-top:4%;" id="cart_empty">
          <div class="col-md-12">
            <h1 class="text-center">Cart is Empty.</h1>
          </div>
        </div>
        {% endif %} 
      </div>
    </section>
    
    <div class="row" style="margin-top:4%; display:none;" id="cart_empty">
      <div class="col-md-12">
        <h1 class="text-center">Cart is Empty.</h1>
      </div>
    </div>
  </div>
</div>

<!-- All your existing scripts remain the same -->
<script>
  $(document).ready(function(){
    country_id = "{{address_obj.country_id}}"
    $.ajax({
      method: "POST",
      url: "/Get_Province/",
      data: {
        'country_id':country_id,
      },
      success: function (response) {
        if (response.status == '1') {
          var province_id = "{{address_obj.province_id}}";
          $('#province').empty();
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select Province'));
          response.data.forEach(element => {
            if (province_id == element.id) {
              $('#province').append($('<option selected style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.name));
              $("#dial_code").val("+" + response.country);
            } else {
              $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.name));
              $("#dial_code").val("+" + response.country);
            }
          });
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        } else {
          $('#province').empty();
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select Province'));
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        }
      }
    });
    
    province_id = "{{address_obj.province_id}}"
    $.ajax({
      method: "POST",
      url: "/get_state_of_country/",
      data: {
        'province_id':province_id,
      },
      success: function (response) {
        if (response.status == '1') {
          var city_id = "{{address_obj.city_id}}";
          $('#city').empty();
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select city'));
          response.data.forEach(element => {
            if (city_id == element.id) {
              $('#city').append($('<option selected style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.city));
            } else {
              $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.city));
            }
          });
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        } else {
          $('#city').empty();
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select city'));
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        }
      }
    });
  });
</script>

<script>
  $("#name").change(function(){ $("#errmsg1").hide(); });
  $("#email").change(function(){ $("#errmsg2").hide(); });
  $("#address1").change(function(){ $("#errmsg3").hide(); });
  $("#dial_code").change(function(){ $("#errmsg4").hide(); });
  $("#mobile").change(function(){ $("#errmsg5").hide(); });
  $("#province").change(function(){ $("#errmsg6").hide(); });
  $("#city").change(function(){ $("#errmsg7").hide(); });
  $("#postal_code").change(function(){ $("#errmsg8").hide(); });
  
  function placeOrder() {
    var name = $("#name").val();
    var email = $("#email").val();
    var address1 = $("#address1").val();
    var address2 = $("#address2").val();
    var country_code = $("#dial_code").val();
    var mobile = $("#mobile").val();
    var province = $("#province").val();
    var city = $("#city").val();
    var postal_code = $("#postal_code").val();
    var note = $("#note").val();
    var country_id = $("#country").val();
    var fk_business = document.getElementById('fk_business').getAttribute('data-fk_vendor-id');
    var sub_total = $("#sub_total").html();
    var delivery_charge = $("#delivery_charge").html();
    var convinience_fee = $("#convinience_fee").html();
    var total_amount = $("#total_amount").html();
    
    if(name == ''){ $("#errmsg1").html("Enter Name"); $("#errmsg1").show(); }
    else if(email == ''){ $("#errmsg2").html("Enter Email"); $("#errmsg2").show(); }
    else if(address1 == ''){ $("#errmsg3").html("Enter Delivery Address"); $("#errmsg3").show(); }
    else if(country_code == ''){ $("#errmsg4").html("Select Country Code"); $("#errmsg4").show(); }
    else if(mobile == ''){ $("#errmsg5").html("Enter Mobile Number"); $("#errmsg5").show(); }
    else if(province == ''){ $("#errmsg6").html("Select Province"); $("#errmsg6").show(); }
    else if(city == ''){ $("#errmsg7").html("Select City"); $("#errmsg7").show(); }
    else if(postal_code == ''){ $("#errmsg8").html("Enter postal code"); $("#errmsg8").show(); }
    else {
      $("#loader").show();
      $.ajax({
        method: "POST",
        url: '/Place_Order/',
        data: {
          "sub_total":sub_total, "total_amount":total_amount, "delivery_charge":delivery_charge,
          "convinience_fee":convinience_fee, "total_quantity":"{{total_quantity}}",
          "name":name, "email":email, "address1":address1, "address2":address2,
          "country_code":country_code, "mobile":mobile, "province":province, "city":city,
          'country_id':country_id, "postal_code":postal_code, "note":note,
          "customer_id":{{request.session.customer_id}}, "fk_business_id": fk_business,
        },
        success: function(response){
          $("#loader").hide();
          if(response.status == '1') {
            swal({
              text: response.msg, icon: 'success', title: 'Success',
              button: "OK", closeOnClickOutside: false,
            }).then((addcat)=>{ window.location.href="/Order_History/"; });
          } else {
            swal({
              text: response.msg, icon: 'info', title: 'Information',
              button: "OK", closeOnClickOutside: false,
            });
          }
        }
      });
    }
  }
  
  function getState() { 
    var province_id = $('#province').val();
    $.ajax({
      method: "POST",
      url: "/get_state_of_country/",
      data: { 'province_id':province_id },
      success: function (response) {
        if (response.status == '1') {
          $('#city').empty();
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select city'));
          response.data.forEach(element => {
            $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.city));
          });
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        } else {
          $('#city').empty();
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select city'));
          $('#city').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        }
      }
    });
  }
</script>

<script>
  function Remove_item(item_id) {
    $.ajax({
      method: "POST",
      url: '/Remove_Cart_Item/',
      data: { "item_id":item_id },
      success: function(response){
        if(response.status == '1') {
          swal({ text: response.msg, icon: 'success', title: 'Success', button: "OK", closeOnClickOutside: false });
          $("#cart_item").html(response.response);
          $("#sub_total").html(response.sub_total);
          $("#total_amount").html(response.total_amount);
          if (response.Item_count == 0) {
            $("#cart_item_count").html(response.Item_count);
            $("#cart_empty").show();
            $("#item_div").hide();
            $("#address_div").hide();
          } else {
            $("#cart_item_count").html(response.Item_count);
          }
        } else {
          swal({ text: response.msg, icon: 'info', title: 'Information', button: "OK", closeOnClickOutside: false });
        }
      }
    });
  }
  
  function Item_Plus(id,item_id,item_price) {
    var quantity = $("#quantity" + id).val();
    var update_quantity = parseInt(quantity) + 1;
    $("#quantity" + id).val(update_quantity);
    $.ajax({
      method: "POST",
      url: '/Update_Cart/',
      data: { "item_id":item_id, "update_quantity":update_quantity, "item_price":item_price },
      success: function(response){
        if(response.status == '1') {
          $("#sub_total").html(response.sub_total);
          $("#total_amount").html(response.total_amount);
        } else {
          swal({ text: response.msg, icon: 'info', title: 'Information', button: "OK", closeOnClickOutside: false });
        }
      }
    });
  }
  
  function Item_Minus(id,item_id,item_price) {
    var quantity = $("#quantity" + id).val();
    if (quantity == 1) {
      $("#quantity" + id).val(quantity);
    } else {
      var update_quantity = parseInt(quantity) - 1;
      $("#quantity" + id).val(update_quantity);
      $.ajax({
        method: "POST",
        url: '/Update_Cart/',
        data: { "item_id":item_id, "update_quantity":update_quantity, "item_price":item_price },
        success: function(response){
          if(response.status == '1') {
            $("#sub_total").html(response.sub_total);
            $("#total_amount").html(response.total_amount);
          } else {
            swal({ text: response.msg, icon: 'info', title: 'Information', button: "OK", closeOnClickOutside: false });
          }
        }
      });
    }
  }
</script>

<script>
  function getProvince() {
    var country_id = $("#country").val();
    $.ajax({
      method: "POST",
      url: "/Get_Province/",
      data: { 'country_id':country_id },
      success: function (response) {
        if (response.status == '1') {
          var city_id = "{{address_obj.country_id}}";
          $('#province').empty();
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select Province'));
          response.data.forEach(element => {
            if (city_id == element.id) {
              $('#province').append($('<option selected style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.name));
              $("#dial_code").val("+" + response.country);
            } else {
              $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val(element.id).text(element.name));
              $("#dial_code").val("+" + response.country);
            }
          });
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        } else {
          $('#province').empty();
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('').text('Select city'));
          $('#province').append($('<option style="background:rgb(50 48 48);color:#bbb6b6;">').val('Other').text('Other'));
        }
      }
    });
  }
</script>

{% include 'customer/footer.html' %}