{% load static %}
{% include 'customer/header.html' %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.2/css/star-rating.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.2/js/star-rating.min.js"></script>

<style>
    .caption, .clear-rating {
        display: none !important;
    }
    .rating-stars {
        font-size: 20px;
        margin-top: -3rem;
    }
    .rating-disabled .rating-input,
    .rating-disabled .rating-stars {
        cursor: pointer !important;
    }
    p {
        color: #d5d5d5;
    }
    .rating-container .filled-stars {
        color: #EE163B !important;
        text-shadow: none;
    }
    .rating-container {
        height: 2rem;
        width: 8rem;
    }
    .set_services {
        margin-bottom: 0;
        margin-top: 7px;
    }
    #show_img {
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }
    div.mm-dropdown {
        border: 1px solid #ddd;
        width: 100%;
        border-radius: 3px;
    }
    div.mm-dropdown ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 0;
    }
    div.mm-dropdown ul li,
    div.mm-dropdown div.textfirst {
        padding: 5px 15px;
        color: #c1c1c1;
        border-bottom: 1px solid #ddd;
    }
    div.mm-dropdown div.textfirst img.down {
        float: right;
        margin-top: 5px;
    }
    div.mm-dropdown ul li:last-child {
        border-bottom: 0;
    }
    div.mm-dropdown ul li {
        display: none;
        padding-left: 25px;
    }
    div.mm-dropdown ul li.main {
        display: block;
    }
    div.mm-dropdown ul li img {
        width: 20px;
        height: 20px;
    }
    ::-webkit-calendar-picker-indicator {
        filter: invert(6);
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .store-mini-card{
        width: 20%;
        margin: 0px 5px;
    }
    .store-mini-card:hover {
        border-color: #EE163B;
        box-shadow: 0 4px 12px rgba(238, 22, 59, 0.12);
        transform: translateY(-2px);
        transition: all 0.18s ease;
    }

    .store-mini-card .card-body {
        transition: background 0.2s;
    }
</style>

<!-- Start main-content -->
<div class="main-content">

    <!-- Section: inner-header -->
    <section class="inner-header layer-overlay overlay-dark-5" style="height: 6.5rem;">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h3 class="title text-white" style="margin-top: -2rem;">Product Details</h3>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="container">
            <div class="section-content">

                <button class="login-btn nextBtn btn-danger btn-sm" 
                        onclick="window.location.href='/items/'" 
                        style="float: right; margin-top: -4%;" 
                        data-toggle="tooltip" data-placement="top" title="Back">
                    <i class="fa fa-arrow-left" aria-hidden="true"></i>
                </button>

                <div class="row">
                    <div class="product">
                        <!-- Left - Image -->
                        <div class="col-md-5">
                            <div class="class-item1">
                                <div class="thumb">
                                    {% if item_obj.item_image %}
                                        <img class="img-responsive img-fullwidth mb-20" 
                                             src="{{ item_obj.item_image.url }}" 
                                             alt="{{ item_obj.item_name }}" 
                                             style="height: 20rem; object-fit: cover;">
                                    {% else %}
                                        <img class="img-responsive img-fullwidth mb-20" 
                                             src="{% static 'images/no_image.jpg' %}" 
                                             alt="No image available" 
                                             style="height: 20rem; object-fit: cover;">
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Right - Details -->
                        <div class="col-md-7">
                            <div class="product-summary">
                                <h2 class="product-title" style="margin-bottom: 0;">{{ item_obj.item_name }}</h2>
                                <h3 style="margin-top: 0; margin-bottom: 3px;">
                                    {{ item_obj.fk_category.category_name }} — {{ item_obj.pet_type }}
                                </h3>
                            </div>

                            <!-- This will be updated when store is selected -->
                            <div class="price" id="selected-price">
                                <ins>
                                    <span class="amount" style="margin-left:-1.5%;">
                                    </span>
                                </ins>
                            </div>

                            <div class="short-description" id="selected-description">
                                <h4 style='font-weight:bold;'>Description:</h4>
                                <p id="desc-text">
                                    <!-- Default can be master item description if you add it later -->
                                    Store Not Found
                                </p>
                            </div>
                            <div class="quantity buttons_added value">
                                <span style="font-weight: bold;color: #d5d5d5;font-size:17px;"> Quantity: </span>
                                <input type="button" class="minus" value="-" onclick="Item_Minus()" >
                                <input type="number" size="4" class="input-text qty text" title="Qty" {% if item_count != None %} value="{{item_count.quantity}}" {% else %} value="1" {% endif %}  name="quantity" min="1" step="1" max="999" style="width: 5%; text-align:center;" id="data">
                                <input type="button" class="plus" value="+" onclick="Item_Plus()" >
                            </div>
                            <div class="cart-form-wrapper mt-30">
                                {% if request.session.customer_email and request.session.customer_id %} 
                                    <button class=" btn btn-danger" onclick='AddtoCart()'  {% if item_obj.available_status == False %} disabled {% endif %} id="addtocart">Add to Cart</button> 
                                {% endif %}
                                {% if request.session.customer_email and request.session.customer_id  %} {% if item_count != None %} <button class="btn btn-danger" onclick="window.location.href='/checkout'">View Cart</button> {% endif %} {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% if store_list %}
                <div class="row" id="store-list-container">
                    {% for entry in store_list %}
                    <div class="col-md-8 col-lg-7 text-center mb-3 shadow-sm store-mini-card"
                        style="border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0; cursor: pointer;"
                        data-price="{{ entry.price|floatformat:2 }}"
                        data-desc="{{ entry.description|default:item_obj.item_name|escapejs }}"
                        data-store-id="{{ entry.store.id }}"
                        onclick="selectStore(this)">

                        <div class="card-body d-flex align-items-center p-3">
                            <div class="flex-grow-1">
                                <h5 class="card-title mb-1" style="font-size: 1.15rem;">
                                    {{ entry.store.bussiness_name }}
                                </h5>

                                <div class="d-flex align-items-center mb-1" style="font-size: 0.95rem; color: #555;">
                                    <small>
                                        {{ entry.store.bussiness_address|truncatewords:8 }}
                                    </small>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div>
                                        <strong style="color: #EE163B; font-size: 1.3rem;">
                                            ₹{{ entry.price|floatformat:2 }}
                                        </strong>
                                        {% if entry.price == 0 or not entry.price %}
                                        <small class="text-muted">(Contact store)</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <p>No stores are currently selling this product.</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <p>No stores found for this item yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </section>
</div>
{% include 'customer/footer.html' %}

<!-- JS For Store Selection -->
<script>
let selectedStoreId = null;  // Global variable to store selected store ID

function selectStore(element) {
    // Remove active class from all cards
    document.querySelectorAll('.store-mini-card').forEach(card => {
        card.style.borderColor = '#e0e0e0';
        card.style.boxShadow = 'none';
        card.style.transform = 'none';  // Reset transform
    });

    // Highlight selected card
    element.style.borderColor = '#EE163B';
    element.style.boxShadow = '0 4px 16px rgba(238, 22, 59, 0.2)';
    element.style.transform = 'translateY(-4px)';

    // Get data
    const price = element.getAttribute('data-price');
    const desc  = element.getAttribute('data-desc');
    selectedStoreId = element.getAttribute('data-store-id');  // Save selected store ID

    // Update price
    const priceEl = document.getElementById('selected-price');
    if (priceEl) {
        let displayPrice = price && price > 0 ? `₹${parseFloat(price).toFixed(2)}` : 'Contact store';
        priceEl.innerHTML = `<ins><span class="amount" style="margin-left:-1.5%;">${displayPrice}</span></ins>`;
    }

    // Update description
    const descEl = document.getElementById('desc-text');
    if (descEl) {
        descEl.textContent = desc || 'No description available from this store.';
    }

    // Enable Add to Cart if disabled (optional: if you want to disable until store selected)
    document.getElementById('addtocart').disabled = false;
}

// Optional: Auto-select first store on page load
window.addEventListener('load', () => {
    const firstCard = document.querySelector('.store-mini-card');
    if (firstCard) {
        selectStore(firstCard);
    } else {
        // If no stores, disable Add to Cart
        document.getElementById('addtocart').disabled = true;
    }
});
</script>

<!-- JS For Item Increasing Decreasing -->
<script>
	function Item_Plus() {
		var quantity = $("#data").val();
		var update_quantity = parseInt(quantity) + 1;
		$("#data").val(update_quantity);
	}
	function Item_Minus() {
		var quantity = $("#data").val();
		if (quantity == 1) {
			$("#data").val(quantity);
		} else {
			var update_quantity = parseInt(quantity) - 1;
			$("#data").val(update_quantity);
		}
	}
</script>

<!-- JS For Add to Cart -->
<script>
function AddtoCart() {
    if (!selectedStoreId) {
        swal({
            text: "Please select a store first.",
            icon: 'info',
            title: 'Information',
            button: "OK",
            closeOnClickOutside: false,
        });
        return;
    }

    var quantity = $("#data").val();
    $.ajax({
        method: "POST",
        url: '/AddtoCart/',  // Adjust URL if needed
        data: {
            "item_id": "{{ item_obj.id }}",  // MasterItem ID
            "store_id": selectedStoreId,     // Selected Store ID
            "quantity": quantity,
            "customer_id": {{ request.session.customer_id }},
            "csrfmiddlewaretoken": "{{ csrf_token }}",  // Add CSRF if not using headers
        },
        success: function(response) {
            if (response.status == '1') {
                swal({
                    text: response.msg,
                    icon: 'success',
                    title: 'Success',
                    button: "OK",
                    closeOnClickOutside: false,
                }).then(() => {
                    window.location.reload();  // Reload to update cart button if needed
                });
            } else {
                swal({
                    text: response.msg,
                    icon: 'info',
                    title: 'Information',
                    button: "OK",
                    closeOnClickOutside: false,
                });
            }
        },
        error: function() {
            swal({
                text: "Something went wrong.",
                icon: 'error',
                title: 'Error',
                button: "OK",
                closeOnClickOutside: false,
            });
        }
    });
}
</script>